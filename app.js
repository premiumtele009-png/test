// ===================== USERS MANAGEMENT - COMPLETE =====================
function refreshUsersTable(){const e=document.getElementById("usersTableBody");if(!e)return;e.innerHTML="",usersData.forEach((t,s)=>{const a=e.insertRow();a.innerHTML=`
<td>${t.username}</td>
<td>${t.fullname}</td>
<td><span class="status-badge status-${t.role}">${t.role.toUpperCase()}</span></td>
<td>${t.branch}</td>
<td><span class="status-badge status-${t.status}">${t.status.toUpperCase()}</span></td>
<td>${t.createdDate||"N/A"}</td>
<td class="actions">
<button class="edit-btn" onclick="editUser(${s})"><i class="fas fa-edit"></i></button>
<button class="delete-btn" onclick="deleteUser(${s})" ${t.username==="admin"?"disabled":""}><i class="fas fa-trash"></i></button>
</td>`})}function openUserModal(){document.getElementById("userModal").style.display="block",document.getElementById("edit_user_index").value="",document.getElementById("userModalTitle").textContent="បន្ថែមអ្នកប្រើប្រាស់ថ្មី",document.getElementById("user_username").value="",document.getElementById("user_fullname").value="",document.getElementById("user_password").value="",document.getElementById("user_role").value="",document.getElementById("user_branch").value="",document.getElementById("user_status").value="active"}function closeUserModal(){document.getElementById("userModal").style.display="none",document.getElementById("userForm").reset()}function editUser(e){const t=usersData[e];document.getElementById("userModal").style.display="block",document.getElementById("edit_user_index").value=e,document.getElementById("userModalTitle").textContent="កែប្រែអ្នកប្រើប្រាស់",document.getElementById("user_username").value=t.username,document.getElementById("user_fullname").value=t.fullname,document.getElementById("user_password").value=t.password,document.getElementById("user_role").value=t.role,document.getElementById("user_branch").value=t.branch,document.getElementById("user_status").value=t.status}function deleteUser(e){const t=usersData[e];if("admin"===t.username)return void showSuccessPopup("មិនអាចលុប Admin account បានទេ!");confirm(`តើអ្នកប្រាកដថាចង់លុប ${t.fullname}?`)&&(usersData.splice(e,1),saveDataToStorage(),refreshUsersTable(),showSuccessPopup("បានលុបអ្នកប្រើប្រាស់ដោយជោគជ័យ!"))}document.getElementById("userForm")?.addEventListener("submit",function(e){e.preventDefault();const t=document.getElementById("edit_user_index").value,s={username:document.getElementById("user_username").value.trim(),password:document.getElementById("user_password").value,fullname:document.getElementById("user_fullname").value.trim(),role:document.getElementById("user_role").value,branch:document.getElementById("user_branch").value.trim(),status:document.getElementById("user_status").value,createdDate:""!==t?usersData[t].createdDate:(new Date).toISOString().split("T")[0]};if(""!==t){if(usersData[t].username!==s.username&&usersData.find(e=>e.username===s.username))return void showSuccessPopup("Username នេះមានរួចហើយ!");usersData[t]=s,showSuccessPopup("បានកែប្រែអ្នកប្រើប្រាស់ដោយជោគជ័យ!")}else{if(usersData.find(e=>e.username===s.username))return void showSuccessPopup("Username នេះមានរួចហើយ!");usersData.push(s),showSuccessPopup("បានបន្ថែមអ្នកប្រើប្រាស់ដោយជោគជ័យ!")}saveDataToStorage(),refreshUsersTable(),closeUserModal()});

// ===================== CUSTOMERS MANAGEMENT - COMPLETE =====================
function refreshCustomersTable(){const e=document.getElementById("customersTableBody");if(!e)return;e.innerHTML="";let t=getFilteredDataByRole(customersData);t.sort((e,t)=>new Date(t.date)-new Date(e.date)),t.length?t.forEach(t=>{const s=customersData.indexOf(t),a=canEditData(t),n=e.insertRow(),d=new Date(t.date).toLocaleDateString("en-GB",{day:"2-digit",month:"2-digit",year:"numeric"});n.innerHTML=`
<td>${d}</td>
<td>${t.staff||"-"}</td>
<td>${t.branch||currentUser.branch}</td>
<td>${t.name}</td>
<td>${t.phone}</td>
<td>${t.product}</td>
<td><span class="status-badge status-${t.status.toLowerCase().replace(" ","-")}">${t.status}</span></td>
<td>${t.remark||"-"}</td>
<td class="actions">
<button class="edit-btn" onclick="editCustomer(${s})" ${a?"":"disabled"}><i class="fas fa-edit"></i></button>
<button class="delete-btn" onclick="deleteCustomer(${s})" ${a?"":"disabled"}><i class="fas fa-trash"></i></button>
</td>`}):e.innerHTML='<tr><td colspan="9" style="text-align:center;padding:30px;color:#6c757d"><i class="fas fa-users" style="font-size:48px;display:block;margin-bottom:10px;opacity:0.3"></i>មិនទាន់មានទិន្នន័យនៅឡើយទេ</td></tr>'}function openCustomerModal(){document.getElementById("customerModal").style.display="block",document.getElementById("edit_customer_index").value="",document.getElementById("customerModalTitle").textContent="បន្ថែមអតិថិជនថ្មី";const e=(new Date).toISOString().split("T")[0];document.getElementById("cust_date").value=e,"admin"!==currentUser.username?(document.getElementById("cust_staff").value=currentUser.fullname,document.getElementById("cust_staff").readOnly=!0):(document.getElementById("cust_staff").value="",document.getElementById("cust_staff").readOnly=!1),document.getElementById("cust_name").value="",document.getElementById("cust_phone").value="",document.getElementById("cust_product").value="",document.getElementById("cust_status").value="",document.getElementById("cust_remark").value=""}function closeCustomerModal(){document.getElementById("customerModal").style.display="none",document.getElementById("customerForm").reset()}function editCustomer(e){const t=customersData[e];if(!canEditData(t))return void showSuccessPopup("អ្នកមិនអាចកែប្រែទិន្នន័យនេះបានទេ!");document.getElementById("customerModal").style.display="block",document.getElementById("edit_customer_index").value=e,document.getElementById("customerModalTitle").textContent="កែប្រែអតិថិជន",document.getElementById("cust_date").value=t.date,document.getElementById("cust_staff").value=t.staff,document.getElementById("cust_name").value=t.name,document.getElementById("cust_phone").value=t.phone,document.getElementById("cust_product").value=t.product,document.getElementById("cust_status").value=t.status,document.getElementById("cust_remark").value=t.remark||""}function deleteCustomer(e){canEditData(customersData[e])?confirm("តើអ្នកប្រាកដថាចង់លុបអតិថិជននេះមែនទេ?")&&(customersData.splice(e,1),saveDataToStorage(),refreshCustomersTable(),showSuccessPopup("បានលុបអតិថិជនដោយជោគជ័យ!")):showSuccessPopup("អ្នកមិនអាចលុបទិន្នន័យនេះបានទេ!")}document.getElementById("customerForm")?.addEventListener("submit",function(e){e.preventDefault();const t=document.getElementById("edit_customer_index").value,s={date:document.getElementById("cust_date").value,staff:document.getElementById("cust_staff").value.trim()||currentUser.fullname,branch:currentUser.branch,name:document.getElementById("cust_name").value.trim(),phone:document.getElementById("cust_phone").value.trim(),product:document.getElementById("cust_product").value,status:document.getElementById("cust_status").value,remark:document.getElementById("cust_remark").value.trim()||"-"};""!==t?(customersData[t]=s,showSuccessPopup("បានកែប្��ែអតិថិជនដោយជោគជ័យ!")):(customersData.push(s),showSuccessPopup("បានបន្ថែមអតិថិជនដោយជោគជ័យ!")),saveDataToStorage(),refreshCustomersTable(),closeCustomerModal()});

// ===================== TOPUP MANAGEMENT - COMPLETE =====================
function refreshTopUpTable(){const e=document.getElementById("topupTableBody");if(!e)return;e.innerHTML="";let t=getFilteredDataByRole(topupData);t.sort((e,t)=>new Date(t.date)-new Date(e.date)),t.length?t.forEach(t=>{const a=topupData.indexOf(t),s=canEditData(t),n=e.insertRow(),d=new Date(t.date).toLocaleDateString("en-GB",{day:"2-digit",month:"2-digit",year:"numeric"}),o=new Date(t.expiry_date).toLocaleDateString("en-GB",{day:"2-digit",month:"2-digit",year:"numeric"});n.innerHTML=`
<td>${d}</td>
<td>${t.staff||"-"}</td>
<td>${t.branch||currentUser.branch}</td>
<td>${t.customer_name}</td>
<td>${t.phone}</td>
<td>${t.contact_phone||"-"}</td>
<td>${t.product}</td>
<td>${o}</td>
<td>${t.remark||"-"}</td>
<td class="actions">
<button class="edit-btn" onclick="editTopUp(${a})" ${s?"":"disabled"}><i class="fas fa-edit"></i></button>
<button class="delete-btn" onclick="deleteTopUp(${a})" ${s?"":"disabled"}><i class="fas fa-trash"></i></button>
</td>`}):e.innerHTML='<tr><td colspan="10" style="text-align:center;padding:30px;color:#6c757d"><i class="fas fa-mobile-alt" style="font-size:48px;display:block;margin-bottom:10px;opacity:0.3"></i>មិនទាន់មានទិន្នន័យនៅឡើយទេ</td></tr>'}function openTopUpModal(){document.getElementById("topupModal").style.display="block",document.getElementById("edit_topup_index").value="",document.getElementById("topupModalTitle").textContent="បន្ថែម Top Up";const e=(new Date).toISOString().split("T")[0];document.getElementById("topup_date").value=e,"admin"!==currentUser.username?(document.getElementById("topup_staff").value=currentUser.fullname,document.getElementById("topup_staff").readOnly=!0):(document.getElementById("topup_staff").value="",document.getElementById("topup_staff").readOnly=!1),document.getElementById("topup_customer").value="",document.getElementById("topup_phone").value="",document.getElementById("topup_contact").value="",document.getElementById("topup_product").value="",document.getElementById("topup_expiry").value="",document.getElementById("topup_remark").value=""}function closeTopUpModal(){document.getElementById("topupModal").style.display="none",document.getElementById("topupForm").reset()}function editTopUp(e){const t=topupData[e];if(!canEditData(t))return void showSuccessPopup("អ្នកមិនអាចកែប្រែទិន្នន័យនេះបានទេ!");document.getElementById("topupModal").style.display="block",document.getElementById("edit_topup_index").value=e,document.getElementById("topupModalTitle").textContent="កែប្រែ Top Up",document.getElementById("topup_date").value=t.date,document.getElementById("topup_staff").value=t.staff,document.getElementById("topup_customer").value=t.customer_name,document.getElementById("topup_phone").value=t.phone,document.getElementById("topup_contact").value=t.contact_phone||"",document.getElementById("topup_product").value=t.product,document.getElementById("topup_expiry").value=t.expiry_date,document.getElementById("topup_remark").value=t.remark||""}function deleteTopUp(e){canEditData(topupData[e])?confirm("តើអ្នកប្រាកដថាចង់លុប Top Up នេះមែនទេ?")&&(topupData.splice(e,1),saveDataToStorage(),refreshTopUpTable(),checkExpiringCustomers(),showSuccessPopup("បានលុប Top Up ដោយជោគជ័យ!")):showSuccessPopup("អ្នកមិនអាចលុបទិន្នន័យនេះបានទេ!")}document.getElementById("topupForm")?.addEventListener("submit",function(e){e.preventDefault();const t=document.getElementById("edit_topup_index").value,a={date:document.getElementById("topup_date").value,staff:document.getElementById("topup_staff").value.trim()||currentUser.fullname,branch:currentUser.branch,customer_name:document.getElementById("topup_customer").value.trim(),phone:document.getElementById("topup_phone").value.trim(),contact_phone:document.getElementById("topup_contact").value.trim()||"-",product:document.getElementById("topup_product").value,expiry_date:document.getElementById("topup_expiry").value,remark:document.getElementById("topup_remark").value.trim()||"-"};""!==t?(topupData[t]=a,showSuccessPopup("បានកែប្រែ Top Up ដោយជោគជ័យ!")):(topupData.push(a),showSuccessPopup("បានបន្ថែម Top Up ដោយជោគជ័យ!")),saveDataToStorage(),refreshTopUpTable(),checkExpiringCustomers(),closeTopUpModal()});

// ===================== EXPIRY CHECKING - COMPLETE =====================
function checkExpiringCustomers(){const e=document.getElementById("expiryTableBody"),t=document.getElementById("expiryWarning"),a=document.getElementById("expiryDangerWarning");if(!e)return;e.innerHTML="";let s=getFilteredDataByRole(topupData);const n=new Date,d=new Date(n);d.setDate(n.getDate()+7);const o=s.filter(e=>{const t=new Date(e.expiry_date);return t<n}).sort((e,t)=>new Date(e.expiry_date)-new Date(t.expiry_date)),i=s.filter(e=>{const t=new Date(e.expiry_date);return t>=n&&t<=d}).sort((e,t)=>new Date(e.expiry_date)-new Date(t.expiry_date)),r=[...o,...i];if(r.length){o.length>0?(a.classList.remove("hidden"),document.getElementById("expiredCount").textContent=o.length):(a.classList.add("hidden"),document.getElementById("expiredCount").textContent="0"),i.length>0?(t.classList.remove("hidden"),document.getElementById("expirySoonCount").textContent=i.length):(t.classList.add("hidden"),document.getElementById("expirySoonCount").textContent="0"),r.forEach(t=>{const a=topupData.indexOf(t),s=canEditData(t),n=e.insertRow(),d=new Date(t.date).toLocaleDateString("en-GB",{day:"2-digit",month:"2-digit",year:"numeric"}),i=new Date(t.expiry_date).toLocaleDateString("en-GB",{day:"2-digit",month:"2-digit",year:"numeric"}),r=new Date(t.expiry_date),l=r<new Date;n.className=l?"expiry-row-danger":"expiry-row-warning";const c=l?'<span class="expiry-status expiry-expired">ផុតកំណត់</span>':'<span class="expiry-status expiry-soon">ជិតផុតកំណត់</span>';n.innerHTML=`
<td>${d}</td>
<td>${t.staff||"-"}</td>
<td>${t.branch||currentUser.branch}</td>
<td>${t.customer_name}</td>
<td>${t.phone}</td>
<td>${t.contact_phone||"-"}</td>
<td>${t.product}</td>
<td>${i}</td>
<td>${c}</td>
<td>${t.remark||"-"}</td>
<td class="actions">
<button class="edit-btn" onclick="editTopUp(${a})" ${s?"":"disabled"}><i class="fas fa-edit"></i></button>
<button class="delete-btn" onclick="deleteTopUp(${a})" ${s?"":"disabled"}><i class="fas fa-trash"></i></button>
</td>`})}else t.classList.add("hidden"),a.classList.add("hidden"),document.getElementById("expiredCount").textContent="0",document.getElementById("expirySoonCount").textContent="0",e.innerHTML='<tr><td colspan="11" style="text-align:center;padding:30px;color:#6c757d"><i class="fas fa-check-circle" style="font-size:48px;margin-bottom:10px;display:block"></i>គ្មានអតិថិជនជិតផុតកំណត់ ឬ ផុតកំណត់ទេ</td></tr>'}

// ===================== PROMOTIONS MANAGEMENT - COMPLETE =====================
function refreshPromotionsGrid(){const e=document.getElementById("promotionsGrid"),t=document.getElementById("promotionsEmptyState");if(!e||!t)return;if(e.innerHTML="",0===promotionsData.length)return e.style.display="none",void(t.classList.remove("hidden"));t.classList.add("hidden"),e.style.display="grid",promotionsData.forEach((t,a)=>{const s=new Date,n=new Date(t.start_date),d=new Date(t.end_date);let o="",i="";s>=n&&s<=d?(o="active",i='<span class="status-badge status-active">កំពុងដំណើរការ</span>'):s<n?(o="upcoming",i='<span class="status-badge" style="background:linear-gradient(135deg,#e3f2fd,#bbdefb);color:#1976d2">នឹងមកដល់</span>'):(o="expired",i='<span class="status-badge status-expired">បានបញ្ចប់</span>');const r=new Date(t.created_date).toLocaleDateString("en-GB",{day:"2-digit",month:"2-digit",year:"numeric"}),l=canEditPromotion(t),c=document.createElement("div");c.className="promotion-card",c.innerHTML=`
<div class="promotion-status">${i}</div>
<h3>${t.campaign}</h3>
<div class="promotion-info"><strong>Channel:</strong> ${t.channel}</div>
<div class="promotion-info"><strong>រយៈពេល:</strong> ${new Date(t.start_date).toLocaleDateString("en-GB")} - ${new Date(t.end_date).toLocaleDateString("en-GB")}</div>
<div class="promotion-terms">
<strong>លក្ខខណ្ឌ:</strong>
<div class="promotion-terms-content collapsed" id="terms-${a}">${t.terms}</div>
<button class="btn-view-more" onclick="toggleTerms(${a})"><span>មើលបន្ថែម</span><i class="fas fa-chevron-down"></i></button>
</div>
<div class="promotion-created-info">
<span><i class="fas fa-user"></i> ${t.created_by||"Admin"}</span>
<span><i class="fas fa-calendar"></i> ${r}</span>
</div>
${l?`
<div class="promotion-actions">
<button class="btn-edit-promo" onclick="editPromotion(${a})"><i class="fas fa-edit"></i> កែប្រែ</button>
<button class="btn-delete-promo" onclick="deletePromotion(${a})"><i class="fas fa-trash"></i> លុប</button>
</div>`:'<div class="view-only-badge"><i class="fas fa-eye"></i> មើលប៉ុណ្ណោះ</div>'}`,e.appendChild(c)})}function toggleTerms(e){const t=document.getElementById(`terms-${e}`),a=t.parentElement.querySelector(".btn-view-more");t.classList.contains("collapsed")?(t.classList.remove("collapsed"),t.classList.add("expanded"),a.classList.add("expanded"),a.querySelector("span").textContent="មើលតិច"):(t.classList.add("collapsed"),t.classList.remove("expanded"),a.classList.remove("expanded"),a.querySelector("span").textContent="មើលបន្ថែម")}function openPromotionModal(){if("admin"!==currentUser?.role)return void showSuccessPopup("អ្នកមិនមានសិទ្ធិបន្ថែមប្រូម៉ូសិនបានទេ!");document.getElementById("promotionModal").style.display="block",document.getElementById("edit_promotion_index").value="",document.getElementById("promotionModalTitle").textContent="បន្ថែមប្រូម៉ូសិន",document.getElementById("promo_channel").value="",document.getElementById("promo_campaign").value="",document.getElementById("promo_start_date").value="",document.getElementById("promo_end_date").value="",document.getElementById("promo_terms").value=""}function closePromotionModal(){document.getElementById("promotionModal").style.display="none",document.getElementById("promotionForm").reset()}function editPromotion(e){const t=promotionsData[e];if(!canEditPromotion(t))return void showSuccessPopup("អ្នកមិនមានសិទ្ធិកែប្រែប្រូម៉ូសិននេះបានទេ!");document.getElementById("promotionModal").style.display="block",document.getElementById("edit_promotion_index").value=e,document.getElementById("promotionModalTitle").textContent="កែប្រែប្រូម៉ូសិន",document.getElementById("promo_channel").value=t.channel,document.getElementById("promo_campaign").value=t.campaign,document.getElementById("promo_start_date").value=t.start_date,document.getElementById("promo_end_date").value=t.end_date,document.getElementById("promo_terms").value=t.terms}function deletePromotion(e){canEditPromotion(promotionsData[e])?confirm("តើអ្នកប្រាកដថាចង់លុបប្រូម៉ូសិននេះមែនទេ?")&&(promotionsData.splice(e,1),saveDataToStorage(),refreshPromotionsGrid(),showSuccessPopup("បានលុបប្រូម៉ូសិនដោយជោគជ័យ!")):showSuccessPopup("អ្នកមិនមានសិទ្ធិលុបប្រូម៉ូសិននេះបានទេ!")}function filterPromotions(e){const t=e.toLowerCase(),a=document.querySelectorAll(".promotion-card");let s=0;a.forEach(e=>{const a=e.textContent.toLowerCase();a.includes(t)?(e.style.display="block",s++):(e.style.display="none")}),document.getElementById("promotionsEmptyState").classList.toggle("hidden",s>0||0===promotionsData.length)}document.getElementById("promotionForm")?.addEventListener("submit",function(e){e.preventDefault();if("admin"!==currentUser?.role)return void showSuccessPopup("អ្នកមិនមានសិទ្ធិបន្ថែមប្រូម៉ូសិនបានទេ!");const t=document.getElementById("edit_promotion_index").value,a={channel:document.getElementById("promo_channel").value.trim(),campaign:document.getElementById("promo_campaign").value.trim(),start_date:document.getElementById("promo_start_date").value,end_date:document.getElementById("promo_end_date").value,terms:document.getElementById("promo_terms").value.trim(),created_by:currentUser.fullname,created_date:""!==t?promotionsData[t].created_date:(new Date).toISOString().split("T")[0]};""!==t?(promotionsData[t]=a,showSuccessPopup("បានកែប្រែប្រូម៉ូសិនដោយជោគជ័យ!")):(promotionsData.push(a),showSuccessPopup("បានបន្ថែមប្រូម៉ូសិនដោយជោគជ័យ!")),saveDataToStorage(),refreshPromotionsGrid(),closePromotionModal()});

console.log('✅ All functions loaded - Users, Customers, TopUp, Promotions COMPLETE');
